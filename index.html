<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>グループチャット</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* 基本フォント設定 */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* カスタムスクロールバースタイル */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* モーダル表示時のアニメーション */
        @keyframes scale-in {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        .animate-scale-in {
            animation: scale-in 0.3s ease-out forwards;
        }
        /* ローディングスピナーのアニメーション */
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        .spinner {
            border-top-color: #3b82f6; /* Tailwind blue-500 */
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 font-inter bg-gradient-to-br from-blue-100 to-purple-200">
    <!-- アプリのルートコンテナ -->
    <div id="app-root" class="shadow-2xl w-full flex flex-col max-w-2xl h-[80vh] rounded-3xl p-4 bg-white">
        <!-- JavaScriptによってコンテンツがここにレンダリングされます -->
    </div>

    <!-- カスタムメッセージボックス (alertの代わり) -->
    <div id="custom-message-box" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="p-6 rounded-lg shadow-xl text-center transform transition-transform duration-300 scale-95 opacity-0 animate-scale-in max-w-sm w-full bg-white text-gray-800">
            <p id="custom-message-text" class="text-lg font-semibold mb-4"></p>
            <button id="custom-message-ok-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">
                OK
            </button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // グローバル変数
        const __firebase_config = typeof window.__firebase_config !== 'undefined' ? window.__firebase_config : '{}';
        const __app_id = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
        const __initial_auth_token = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : null;

        // グローバルなFirebaseインスタンス
        let app = null;
        let db = null;
        let auth = null;
        let userId = '';
        let userName = '';

        // DOM要素の取得
        const appRoot = document.getElementById('app-root');
        const customMessageBox = document.getElementById('custom-message-box');
        const customMessageText = document.getElementById('custom-message-text');
        const customMessageOkBtn = document.getElementById('custom-message-ok-btn');

        // Firestoreのコレクションパス
        const messagesCollectionPath = `artifacts/${__app_id}/public/data/messages`;

        /**
         * カスタムメッセージボックスを表示する関数。
         * @param {string} message - 表示するメッセージテキスト。
         */
        function showMessageBox(message) {
            customMessageText.textContent = message;
            customMessageBox.classList.remove('hidden');
            customMessageBox.querySelector('div:first-child').classList.add('animate-scale-in');
        }

        /**
         * カスタムメッセージボックスを非表示にする関数。
         */
        function hideMessageBox() {
            customMessageBox.classList.add('hidden');
            customMessageBox.querySelector('div:first-child').classList.remove('animate-scale-in');
        }

        /**
         * ローディング画面をレンダリングする関数。
         */
        function renderLoadingScreen() {
            appRoot.className = "shadow-2xl w-full flex flex-col max-w-2xl h-[80vh] rounded-3xl p-4 bg-white text-gray-800";
            appRoot.innerHTML = `
                <div class="flex flex-col items-center justify-center flex-grow p-8">
                    <div class="spinner h-12 w-12 border-4 border-gray-200 rounded-full mb-4"></div>
                    <p class="text-lg text-gray-700">読み込み中...</p>
                </div>
            `;
        }

        /**
         * ログイン画面をレンダリングする関数。
         */
        function renderLoginScreen() {
            appRoot.className = "shadow-2xl w-full flex flex-col max-w-2xl h-[80vh] rounded-3xl p-4 bg-white text-gray-800";
            appRoot.innerHTML = `
                <h1 class="text-2xl font-extrabold mb-2 text-center text-gray-800">グループチャット</h1>
                <div class="flex flex-col items-center justify-center flex-grow p-8">
                    <p class="text-lg mb-6 text-center text-gray-700">チャットに参加するために名前を入力してください</p>
                    <input type="text" id="username-input" placeholder="あなたの名前" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-base mb-4 text-center" />
                    <p id="error-message" class="text-red-500 text-sm mb-4 hidden"></p>
                    <button id="login-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        チャットに参加
                    </button>
                    <p class="absolute bottom-4 left-4 text-xs text-gray-500">
                        Made by Gemini
                    </p>
                </div>
            `;
            attachLoginEventListeners();
        }

        /**
         * チャット画面をレンダリングする関数。
         * @param {Array<Object>} messages - 表示するメッセージの配列。
         */
        function renderChatScreen(messages = []) {
            appRoot.className = "shadow-2xl w-full flex flex-col max-w-full h-screen rounded-none p-4 bg-white text-gray-800 transition-all duration-700 ease-out opacity-100 scale-100";
            appRoot.innerHTML = `
                <div class="flex justify-between items-center mb-4 pb-2 border-b border-gray-200">
                    <p class="text-gray-600 text-sm">
                        あなたのユーザーID: <span class="font-semibold text-blue-700">${userId}</span>
                    </p>
                    <p class="text-gray-600 text-sm">
                        あなたの名前: <span class="font-semibold text-purple-700">${userName}</span>
                    </p>
                </div>
                <div id="chat-message-box" class="flex-grow overflow-y-auto p-4 bg-gray-50 rounded-lg mb-4 shadow-inner custom-scrollbar">
                    <!-- メッセージがここにレンダリングされます -->
                </div>
                <div class="flex gap-3">
                    <input type="text" id="message-input" placeholder="メッセージを入力..." class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    <button id="send-message-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                        送信
                    </button>
                </div>
            `;
            renderMessages(messages);
            attachChatEventListeners();
            scrollToBottom();
        }

        /**
         * メッセージを表示する関数。
         * @param {Array<Object>} messages - 表示するメッセージの配列。
         */
        function renderMessages(messages) {
            const chatMessageBox = document.getElementById('chat-message-box');
            if (!chatMessageBox) return;

            chatMessageBox.innerHTML = '';
            
            if (messages.length === 0) {
                const noMessageText = document.createElement('p');
                noMessageText.className = 'text-center text-gray-500 italic';
                noMessageText.textContent = 'まだメッセージはありません。最初のメッセージを送信してください！';
                chatMessageBox.appendChild(noMessageText);
            } else {
                messages.forEach(msg => {
                    const isMyMessage = msg.userId === userId;
                    
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `flex mb-3 ${isMyMessage ? 'justify-end' : 'justify-start'}`;

                    const messageBubble = document.createElement('div');
                    messageBubble.className = `max-w-[70%] p-3 rounded-xl shadow-sm ${
                        isMyMessage ? 'bg-blue-500 text-white rounded-br-none' : 'bg-gray-200 text-gray-800 rounded-bl-none'
                    }`;

                    const senderName = document.createElement('div');
                    senderName.className = 'font-bold text-sm mb-1';
                    senderName.textContent = isMyMessage ? 'あなた' : msg.userName || '匿名ユーザー';
                    messageBubble.appendChild(senderName);

                    const p = document.createElement('p');
                    p.className = 'text-base break-words';
                    p.textContent = msg.messageText;
                    messageBubble.appendChild(p);

                    const timestampDiv = document.createElement('div');
                    timestampDiv.className = 'text-xs text-right mt-1 opacity-75';
                    timestampDiv.textContent = msg.timestamp?.toDate ? msg.timestamp.toDate().toLocaleTimeString('ja-JP') : '送信中...';
                    messageBubble.appendChild(timestampDiv);
                    
                    messageDiv.appendChild(messageBubble);
                    chatMessageBox.appendChild(messageDiv);
                });
            }
        }

        function scrollToBottom() {
            const chatMessageBox = document.getElementById('chat-message-box');
            if (chatMessageBox) {
                chatMessageBox.scrollTop = chatMessageBox.scrollHeight;
            }
        }

        // --- イベントリスナーとハンドラ ---
        function attachLoginEventListeners() {
            const loginBtn = document.getElementById('login-btn');
            const usernameInput = document.getElementById('username-input');

            if (loginBtn) {
                loginBtn.onclick = handleSetUserName;
            }
            if (usernameInput) {
                usernameInput.onkeypress = (e) => { if (e.key === 'Enter') handleSetUserName(); };
            }
        }

        function attachChatEventListeners() {
            const sendMessageBtn = document.getElementById('send-message-btn');
            const messageInput = document.getElementById('message-input');

            if (sendMessageBtn) {
                sendMessageBtn.onclick = handleSendMessage;
            }
            if (messageInput) {
                messageInput.onkeypress = (e) => { if (e.key === 'Enter') handleSendMessage(); };
            }
            if (customMessageOkBtn) {
                customMessageOkBtn.onclick = hideMessageBox;
            }
        }

        async function handleSetUserName() {
            const usernameInput = document.getElementById('username-input');
            const errorMessageElem = document.getElementById('error-message');
            const newName = usernameInput.value.trim();

            if (newName === '') {
                errorMessageElem.textContent = '名前を入力してください。';
                errorMessageElem.classList.remove('hidden');
                return;
            }

            errorMessageElem.classList.add('hidden');
            userName = newName;
            renderChatScreen();

            // ここでFirebaseのonSnapshotリスナーをアタッチ
            attachMessageListener();
        }

        async function handleSendMessage() {
            const messageInputElem = document.getElementById('message-input');
            const messageText = messageInputElem.value.trim();

            if (messageText === '' || !db || !userId || !userName) {
                return;
            }

            try {
                await addDoc(collection(db, messagesCollectionPath), {
                    userId: userId,
                    userName: userName,
                    messageText: messageText,
                    timestamp: serverTimestamp()
                });
                messageInputElem.value = '';
            } catch (error) {
                console.error("メッセージ送信エラー:", error);
                showMessageBox("メッセージの送信に失敗しました。もう一度お試しください。");
            }
        }

        /**
         * FirestoreのonSnapshotリスナーをアタッチする関数。
         */
        function attachMessageListener() {
            if (!db || !userId) {
                console.error("Firestoreまたはユーザーが未初期化です。");
                return;
            }

            const q = query(collection(db, messagesCollectionPath), orderBy('timestamp', 'asc'));
            
            onSnapshot(q, (snapshot) => {
                const messages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMessages(messages);
                scrollToBottom();
            }, (error) => {
                console.error("メッセージのリアルタイム更新エラー:", error);
                showMessageBox("チャットデータの読み込み中にエラーが発生しました。");
            });
        }
        
        // --- 初期化 ---
        document.addEventListener('DOMContentLoaded', async () => {
            renderLoadingScreen(); // 最初にローディング画面を表示
            
            try {
                // Firebaseを初期化
                const firebaseConfig = JSON.parse(__firebase_config);
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 認証
                await new Promise(resolve => {
                    const unsubscribe = onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            unsubscribe();
                            resolve();
                        } else {
                            try {
                                if (__initial_auth_token) {
                                    await signInWithCustomToken(auth, __initial_auth_token);
                                } else {
                                    await signInAnonymously(auth);
                                }
                            } catch (error) {
                                console.error("認証エラー:", error);
                                showMessageBox("認証エラーが発生しました。");
                            }
                        }
                    });
                });

                // 認証が完了したらログイン画面へ
                renderLoginScreen();
            } catch (error) {
                console.error("Firebase初期化エラー:", error);
                showMessageBox("アプリケーションの初期化に失敗しました。");
            }

            if (customMessageOkBtn) {
                customMessageOkBtn.onclick = hideMessageBox;
            }
        });
    </script>
</body>
</html>
